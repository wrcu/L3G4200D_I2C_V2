/*********************************Copyright (c)*********************************
**                               
**
**--------------File Info-------------------------------------------------------
** File Name:               l3g4200.c
** Last modified Date:      
** Last Version:            
** Description:             三維陀螺儀傳感器
**
**------------------------------------------------------------------------------
** Created By:              wanxuncpx
** Created date:            
** Version:                 
** Descriptions:            
**
*******************************************************************************/

/******************************************************************************
更新說明:
    
******************************************************************************/

/******************************************************************************
*********************************  應 用 資 料 ********************************
******************************************************************************/

/******************************************************************************
********************************* 文件引用部分 ********************************
******************************************************************************/
#include "sensor.h"
#include "stm32f4_discovery.h"
#include <stdio.h>

/******************************************************************************
******************************* 自定義參數配置 ********************************
******************************************************************************/


/******************************************************************************
********************************* 數 據 聲 明 *********************************
******************************************************************************/
/*---------------------* 
*    IMPORT:由外提供   * 
*----------------------*/
//none

/*---------------------* 
*    EXPORT:向外提供   * 
*----------------------*/
//none

/******************************************************************************
********************************* 函 數 聲 明 *********************************
******************************************************************************/
/*---------------------* 
*    IMPORT:由外提供   * 
*----------------------*/
//none

/*---------------------* 
*    EXPORT:向外提供   * 
*----------------------*/
//none



/******************************************************************************
*********************************  程序開始  **********************************
******************************************************************************/


/******************************************************************************
/ 函數功能:初始化L3G4200
/ 修改日期:none
/ 輸入參數:none
/ 輸出參數:none
/ 使用說明:none
******************************************************************************/
void L3G4200D_Init(void)
{
    //速率帶寬選擇和XYZ軸使能開關  
    Single_Write(L3G4200_Addr,CTRL_REG1, 0x0f|(0<<4));   //100Hz    0:12.5 ,1:25 ,2:25 ,3:25
    //Single_Write(L3G4200_Addr,CTRL_REG1, 0x8f|(0<<4));   //400Hz, 0:20 ,1:25 ,2:50 ,3:110
    //Single_Write(L3G4200_Addr,CTRL_REG1, 0xCf|(0<<4));   //800Hz, 0:30 ,1:35 ,2:50 ,3:110
    
    //高通設置
    Single_Write(L3G4200_Addr,CTRL_REG2, 0x03); //100hz使用,高通1Hz
    //Single_Write(L3G4200_Addr,CTRL_REG2, 0x05); //400hz使用,高通1Hz
    //Single_Write(L3G4200_Addr,CTRL_REG2, 0x05); //800hz使用,高通1Hz
    
    //輸出信號引腳配置
    Single_Write(L3G4200_Addr,CTRL_REG3, 0xA8); //DRDY引腳,IDLE:0,
    
    //測量精度, 數據更新方式
    Single_Write(L3G4200_Addr,CTRL_REG4, 0x30|(1<<7)); //+-2000dps, 1:使用阻塞,0:事實更新xyz
    
    //高低通濾波選擇
    //Single_Write(L3G4200_Addr,CTRL_REG5, 0x00); //只使用原始低通LPF1
    //Single_Write(L3G4200_Addr,CTRL_REG5, 0x05); //只使用LPF1+HPF
    Single_Write(L3G4200_Addr,CTRL_REG5, 0x0F|(1<<4)); //使用用LPF1+LPF2,bit控制是否使用HPF
}

/******************************************************************************
/ 函數功能:讀取L3G4200D的傳感器數據
/ 修改日期:none
/ 輸入參數:none
/ 輸出參數:none
/ 使用說明:none
******************************************************************************/
void L3G4200D_Read(tg_L3G4200D_TYPE * ptResult)
{
    uint8_t tmp[6];
    
    tmp[0]=Single_Read(L3G4200_Addr,OUT_X_L);
    tmp[1]=Single_Read(L3G4200_Addr,OUT_X_H);   
    
    tmp[2]=Single_Read(L3G4200_Addr,OUT_Y_L);
    tmp[3]=Single_Read(L3G4200_Addr,OUT_Y_H);
    
    tmp[4]=Single_Read(L3G4200_Addr,OUT_Z_L);
    tmp[5]=Single_Read(L3G4200_Addr,OUT_Z_H);
    printf("tmp=%d\r\n",tmp[0]);
    ptResult->gx    = (int16_t)((tmp[1]<<8)|tmp[0]);
    ptResult->gy    = (int16_t)((tmp[3]<<8)|tmp[2]);
    ptResult->gz    = (int16_t)((tmp[5]<<8)|tmp[4]);
}

/******************************************************************************
/ 函數功能:讀取L3G4200D的傳感器數據(多讀)
/ 修改日期:none
/ 輸入參數:none
/ 輸出參數:none
/ 使用說明:none
******************************************************************************/
void L3G4200D_MultRead(tg_L3G4200D_TYPE * ptResult)
{
    uint8_t tmp[6];

    if(true == Mult_Read(L3G4200_Addr,(OUT_X_L|0x80),tmp,6))
    {   //ptResult->gx    = (int16_t)((tmp[1]<<8)|tmp[0]);
        //ptResult->gy    = (int16_t)((tmp[3]<<8)|tmp[2]);
        //ptResult->gz    = (int16_t)((tmp[5]<<8)|tmp[4]);
        ptResult->gx      = *( (int16_t *)(&tmp[0]) );      //優化效果明顯
        ptResult->gy      = *( (int16_t *)(&tmp[2]) );
        ptResult->gz      = *( (int16_t *)(&tmp[4]) );
    }
}



/******************************************************************************
/ 函數功能:打印L3G4200D的傳感器數據
/ 修改日期:none
/ 輸入參數:none
/ 輸出參數:none
/ 使用說明:none
******************************************************************************/
void L3G4200D_Printf(tg_L3G4200D_TYPE * ptResult)
{
    int32_t tempX,tempY,tempZ;
   // USART3_Config();
    //temp=(float)dis_data*0.07;  //計算數據和顯示,查考ADXL345快速入門第4頁
    tempX = (int32_t)ptResult->gx;   tempX = (tempX*7)/100;
    tempY = (int32_t)ptResult->gy;   tempY = (tempY*7)/100;
    tempZ = (int32_t)ptResult->gz;   tempZ = (tempZ*7)/100;
    printf("%d  %d  %d\r\n",tempX,tempY,tempZ);
    printf("L3G4200D:\tgx: %d,\tgy: %d,\tgz: %d\n\r",tempX,tempY,tempZ);
}




